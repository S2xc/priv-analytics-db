# PrivAnalyticsDB

**Zero-trust ClickHouse proxy with AES-256-GCM encryption out-of-the-box.**

## Quick start:

```bash
docker compose up -d
export PA_KEY=$(curl -s -H "Authorization: Bearer demo-key-123" http://localhost:8000/key)
curl -s -H "Authorization: Bearer demo-key-123" \
  -X POST http://localhost:8000/query \
  -H "Content-Type: application/json" \
  -d '{"query":"SELECT 1","fmt":"JSONEachRow"}' \
  | PYTHONPATH=proxy python client/decrypt.py --in - --out -
```
## Example:
```bash
(.venv) (base) s2xdeb@MacBook-Air-s2x priv-analytics-db % curl -s -H "Authorization: Bearer demo-key-123" \
  -X POST http://localhost:8000/query \
  -H "Content-Type: application/json" \
  -d '{"query":"SELECT 1","fmt":"JSONEachRow"}'
```
## Output:
```bash
{"encrypted_data":"P6H0zWUwkb9c3PrnHiRwaCVkYzK8ymOg","key_id":"40607","iv":"cbmkwKZF0zrDfAEc","algorithm":"AES-256-GCM"}% 
```

## launch:
```bash
cd proxy
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```
‚∏ª

# üîπ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π API-—Å–µ—Ä–≤–∏—Å (–ø—Ä–æ–∫—Å–∏). –ü—Ä–æ–∫—Å–∏ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞. –¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–ª—è –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–ø—Ä–æ—Å–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º.

## üîπ –ú–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞

POST /query

HTTP-–∑–∞–ø—Ä–æ—Å –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é http://localhost:8000/query).

## üîπ –ó–∞–ø—Ä–æ—Å

–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:

```bash
curl -s -H "Authorization: Bearer demo-key-123" \
  -X POST http://localhost:8000/query \
  -H "Content-Type: application/json" \
  -d '{"query":"SELECT 1","fmt":"JSONEachRow"}'
```

–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:

–≠–ª–µ–º–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å–∞	–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
Authorization: Bearer demo-key-123	–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
Content-Type: application/json	–£–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ ‚Äî JSON.
-d '{"query":"...","fmt":"..."}'	JSON-–æ–±—ä–µ–∫—Ç —Å SQL-–∑–∞–ø—Ä–æ—Å–æ–º –∏ —Ñ–æ—Ä–º–∞—Ç–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.

–ü–æ–ª—è —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞:

–ü–æ–ª–µ	–¢–∏–ø	–û–ø–∏—Å–∞–Ω–∏–µ
query	string	SQL-–∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —á–µ—Ä–µ–∑ ClickHouse.
fmt	string	–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞. –ù–∞–ø—Ä–∏–º–µ—Ä, JSONEachRow –∏–ª–∏ JSON.

–í –¥–∞–Ω–Ω–æ–º –ø—Ä–∏–º–µ—Ä–µ SELECT 1 ‚Äî –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞.

## üîπ –û—Ç–≤–µ—Ç

–ü—Ä–∏–º–µ—Ä:
```bash
{
  "encrypted_data": "P6H0zWUwkb9c3PrnHiRwaCVkYzK8ymOg",
  "key_id": "40607",
  "iv": "cbmkwKZF0zrDfAEc",
  "algorithm": "AES-256-GCM"
}
```
–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª–µ–π:

–ü–æ–ª–µ	–û–ø–∏—Å–∞–Ω–∏–µ
encrypted_data	–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç SQL-–∑–∞–ø—Ä–æ—Å–∞. –î–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ Base64.
key_id	–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª—é—á–∞, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è.
iv	–í–µ–∫—Ç–æ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (Initialization Vector) ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è AES-GCM.
algorithm	–ê–ª–≥–æ—Ä–∏—Ç–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è, –≤—Å–µ–≥–¥–∞ AES-256-GCM.

–≠—Ç–æ—Ç –æ—Ç–≤–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω. –î–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º key_id.

## üîπ –î–µ—à–∏—Ñ—Ä–æ–≤–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

–†–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É—è —É—Ç–∏–ª–∏—Ç—É:

echo '{...}' | PYTHONPATH=proxy python client/decrypt.py

–£—Ç–∏–ª–∏—Ç–∞ –¥–æ–ª–∂–Ω–∞ —É–º–µ—Ç—å:
	‚Ä¢	–Ω–∞–π—Ç–∏ –∫–ª—é—á –ø–æ key_id;
	‚Ä¢	–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å iv –∏ algorithm –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏;
	‚Ä¢	–≤—ã–≤–µ—Å—Ç–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –æ—Ç ClickHouse.

## üîπ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

–≠—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ –ø–æ–≤—ã—à–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –î–∞–∂–µ –µ—Å–ª–∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å —Å–µ—Ç–µ–≤–æ–π —Ç—Ä–∞—Ñ–∏–∫, –¥–∞–Ω–Ω—ã–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–ª—é—á–∞–º. –¢–∞–∫–æ–π –º–µ—Ö–∞–Ω–∏–∑–º –º–æ–∂–µ—Ç –±—ã—Ç—å —á–∞—Å—Ç—å—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, –≥–¥–µ –∫–ª–∏–µ–Ω—Ç –∏ —Å–µ—Ä–≤–µ—Ä —Ñ–∏–∑–∏—á–µ—Å–∫–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –∏ —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç—É –¥–æ—Å—Ç—É–ø–Ω—ã –∫–ª—é—á–∏ –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏.
